trigger:
- main
- staging
- release

parameters:
  - name: Platforms
    type: object
    default:
    - x86
    - x64
    - arm64
  - name: Configurations
    type: object
    default:
    - debug
    - release

variables:
  MSIXVersion: '0.1800'
  solution: '**/GitHubExtension.sln'
  appxPackageDir: 'AppxPackages'

resources:
  repositories:
  - repository: m365Pipelines
    type: git
    name: 1ESPipelineTemplates/M365GPT
    ref: refs/tags/release

pool:
  vmImage: windows-2022

stages:
- stage: pre_process
  displayName: Pre-processing code
  jobs:
  - job: script_changes
    displayName: Script changes
    steps:
      - task: PowerShell@2
        displayName: Running script to update OAuth secrets
        inputs:
          filePath: './build/scripts/OAuthSecrets.ps1'
          arguments: -ClientId $(GitHubOAuthClientId) -ClientSecret $(GitHubOAuthClientSecret)

- stage: build
  displayName: Build
  jobs:
  - ${{ each configuration in parameters.Configurations }}:
        - ${{ each platform in parameters.Platforms }}:
          - job: Build_${{ platform }}_${{ configuration }}
            steps:
            - task: MSBuild@1
              displayName: Restoring packages
              inputs:
                solution: '$(solution)'
                msbuildArchitecture: '${{ platform }}'
                platform: '${{ platform }}'
                configuration: '${{ configuration }}'
                msbuildArguments: '/t:Restore'

            - task: MsixPackaging@1
              displayName: Building MSIX
              inputs:
                outputPath: '$(Build.ArtifactStagingDirectory)\GitHubExtension${{ configuration }}_${{ platform }}.msix'
                solution: '$(solution)'
                clean: false
                generateBundle: false
                buildConfiguration: '${{ configuration }}'
                buildPlatform: '${{ platform }}'
                updateAppVersion: false
                appPackageDistributionMode: 'SideloadOnly'
                msbuildLocationMethod: 'version'
                msbuildVersion: 'latest'
                msbuildArchitecture: '${{ platform }}'

            - task: CopyFiles@2
              displayName: Copying files to Artifact Staging directory
              inputs:
                SourceFolder: './BuildOutput'
                Contents: '**'
                TargetFolder: '$(Build.ArtifactStagingDirectory)'

            - task: PublishBuildArtifacts@1
              displayName: Publishing artifacts
              inputs:
                PathtoPublish: '$(Build.ArtifactStagingDirectory)'
                ArtifactName: 'drop'
                publishLocation: 'Container'
