trigger:
- main
- staging
- release

parameters:
  - name: Platforms
    type: object
    default:
    - x86
    - x64
    - arm64
  - name: Configurations
    type: object
    default:
    - debug
    - release

variables:
  MSIXVersion: '0.1800'
  solution: '**/GitHubExtension.sln'
  appxPackageDir: 'AppxPackages'

resources:
  repositories:
  - repository: m365Pipelines
    type: git
    name: 1ESPipelineTemplates/M365GPT
    ref: refs/tags/release

pool:
  vmImage: windows-2022

stages:
- stage: pre_process
  displayName: Pre-processing code
  jobs:
  - job: script_changes
    displayName: Script changes
    steps:
      - task: PowerShell@2
        inputs:
          filePath: './build/scripts/OAuthSecrets.ps1'
          arguments: -ClientId $(GitHubOAuthClientId) -ClientSecret $(GitHubOAuthClientSecret)

  - job: restore
    steps:
    - task: NuGetCommand@2
      inputs:
        command: 'restore'
        restoreSolution: '$(solution)'
        feedsToUse: 'config'
        nugetConfigPath: './nuget.config'

- stage: build
  displayName: Build
  jobs:
  - ${{ each configuration in parameters.Configurations }}:
        - ${{ each platform in parameters.Platforms }}:
          - job: Build_${{ platform }}_${{ configuration }}
            steps:
            - task: MSBuild@1
              inputs:
                solution: '$(solution)'
                msbuildArchitecture: '${{ platform }}'
                platform: '${{ platform }}'
                configuration: '${{ configuration }}'
                msbuildArguments: '/t:Restore'

            - task: MsixPackaging@1
              inputs:
                outputPath: '$(Build.ArtifactStagingDirectory)\GitHubExtension.msix'
                solution: '$(solution)'
                clean: false
                generateBundle: false
                buildConfiguration: '${{ configuration }}'
                buildPlatform: '${{ platform }}'
                updateAppVersion: false
                appPackageDistributionMode: 'SideloadOnly'
                msbuildLocationMethod: 'version'
                msbuildVersion: 'latest'
                msbuildArchitecture: '${{ platform }}'
     
- stage: copy_files
  jobs:
  - job: copy_files
    steps:
    - task: CopyFiles@2
      inputs:
        SourceFolder: './BuildOutput'
        Contents: '**'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'